<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizing Complexity: Advanced System Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;500;700&family=Inter:wght@400;700&display=swap');

        body {
            margin: 0;
            overflow: hidden;
            background-color: #020617;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
        }

        canvas {
            display: block;
        }

        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
            border-color: #60a5fa;
        }

        .hud-label {
            position: absolute;
            pointer-events: none;
            font-family: 'Space Grotesk', sans-serif;
            transition: opacity 0.3s;
        }

        #info-panel {
            transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            width: 28rem;
            max-height: 85vh;
        }

        #info-panel.collapsed {
            width: 16rem;
            max-height: 64px;
            cursor: pointer;
        }

        .hide-on-collapse {
            transition: opacity 0.3s;
        }

        .collapsed .hide-on-collapse {
            opacity: 0;
            pointer-events: none;
        }

        .status-pill {
            padding: 2px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .vicious-cycle {
            color: #ef4444;
            border: 1px solid #ef4444;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>

    <!-- HUD Layer -->
    <div id="hud-container" class="fixed inset-0 pointer-events-none z-10"></div>

    <!-- Top Navigation -->
    <div
        class="fixed top-0 left-0 w-full p-6 z-30 flex flex-col md:flex-row justify-between items-start pointer-events-none">
        <div class="pointer-events-auto">
            <h1 class="text-2xl font-black tracking-tighter text-blue-500 flex items-center gap-2">
                SYSTEM STEWARD v3.0
            </h1>
            <p class="text-[10px] font-bold text-slate-500 uppercase tracking-[0.2em]">Cognitive Fit & System Dynamics
                Interface</p>
        </div>

        <div class="flex flex-wrap gap-2 mt-4 md:mt-0 pointer-events-auto glass p-1 rounded-xl">
            <button onclick="switchScene('iceberg')" id="btn-iceberg"
                class="nav-btn active px-4 py-2 rounded-lg text-[10px] font-bold uppercase transition-all border border-transparent">1.
                Deep Structure</button>
            <button onclick="switchScene('reef')" id="btn-reef"
                class="nav-btn px-4 py-2 rounded-lg text-[10px] font-bold uppercase transition-all border border-transparent">2.
                NHS Network</button>
            <button onclick="switchScene('dynamics')" id="btn-dynamics"
                class="nav-btn px-4 py-2 rounded-lg text-[10px] font-bold uppercase transition-all border border-transparent">3.
                Feedback Loop</button>
            <button onclick="switchScene('pfi')" id="btn-pfi"
                class="nav-btn px-4 py-2 rounded-lg text-[10px] font-bold uppercase transition-all border border-transparent">4.
                Debt Horizon</button>
        </div>
    </div>

    <!-- Interactive Simulation Sidebar -->
    <div id="controls-panel"
        class="fixed right-6 top-1/2 -translate-y-1/2 w-80 glass p-6 rounded-2xl z-30 hidden border-l-4 border-blue-500">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xs font-black text-blue-400 uppercase tracking-widest">Feedback Control</h3>
            <span id="cycle-alert" class="status-pill hidden">Vicious Cycle Detected</span>
        </div>

        <div class="space-y-8">
            <div class="group">
                <div class="flex justify-between text-[10px] mb-2 font-bold text-slate-400">
                    <label>EXTERNAL RECRUITMENT</label>
                    <span id="val-rec" class="text-blue-400">50%</span>
                </div>
                <input type="range" id="slider-rec"
                    class="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer" min="0" max="100"
                    value="50">
            </div>
            <div class="group">
                <div class="flex justify-between text-[10px] mb-2 font-bold text-slate-400">
                    <label>SYSTEM PRESSURE (DELAY)</label>
                    <span id="val-pres" class="text-orange-400">LOW</span>
                </div>
                <input type="range" id="slider-pres"
                    class="w-full h-1 bg-slate-800 rounded-lg appearance-none cursor-pointer" min="0" max="100"
                    value="20">
            </div>
            <div class="p-4 bg-blue-500/5 rounded-lg border border-blue-500/20">
                <p class="text-[10px] leading-relaxed text-slate-400">
                    <b class="text-blue-400">Model Logic:</b> This simulation includes <span class="italic">Reinforcing
                        Feedback</span>. As stock falls below 30%, attrition accelerates automatically due to workload
                    stress.
                </p>
            </div>
        </div>
    </div>

    <!-- Narrative Insight Panel -->
    <div id="info-panel" class="fixed bottom-6 left-6 p-6 glass rounded-2xl z-30 shadow-2xl" onclick="expandPanel()">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
                <div id="scene-dot" class="w-3 h-3 bg-blue-500 rounded-full shadow-[0_0_10px_#3b82f6]"></div>
                <h2 id="scene-title" class="text-xl font-bold tracking-tight text-white uppercase italic">The Iceberg
                    Model</h2>
            </div>
            <button onclick="togglePanel(event)" class="hover:bg-white/10 p-1 rounded transition-transform duration-300"
                id="chevron">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="m18 15-6-6-6 6" />
                </svg>
            </button>
        </div>

        <div class="hide-on-collapse">
            <p id="scene-desc" class="text-sm text-slate-400 leading-relaxed mb-6 border-l-2 border-slate-700 pl-4">
                Loading system intelligence...
            </p>
            <div id="data-stats" class="grid grid-cols-2 gap-4 bg-slate-900/50 p-4 rounded-xl border border-white/5">
                <!-- Dynamic Content -->
            </div>
        </div>
    </div>

    <script>
        // --- System Data Architecture ---
        const systemData = {
            iceberg: {
                title: "Epistemological Crisis",
                dot: "#3b82f6",
                desc: "Management orthodoxy relies on the 'Tip' (Snapshots). Effective stewardship requires visualizing the deep Structures (Funding/Statutes) and Mental Models (Culture) that prevent system change.",
                stats: [
                    { label: "Visible Metrics", val: "Events/KPIs" },
                    { label: "Hidden Drivers", val: "Structural Bias" }
                ],
                hud: [
                    { pos: [0, 3, 0], text: "SYSTEM 1: KPI SNAPSHOTS", sub: "Events & Symptoms" },
                    { pos: [0, -3, 0], text: "SYSTEM 2: CAUSAL STRUCTURE", sub: "Policy Incentives" },
                    { pos: [0, -7, 0], text: "DEEP: MENTAL MODELS", sub: "Cognitive Paradigms" }
                ],
                clusters: [
                    { pos: [3, 4, 2], text: "A&E WAITS" },
                    { pos: [-3, 3.5, 1], text: "BED BLOCKING" },
                    { pos: [2, 2.5, -2], text: "RTT TARGETS" },
                    { pos: [4, -2, 3], text: "PFI CONTRACTS" },
                    { pos: [-4, -3, -2], text: "SILOED BUDGETS" },
                    { pos: [2, -4, 2], text: "TARIFF PAYMENTS" },
                    { pos: [-3, -4.5, 3], text: "ALLOCATIVE EFFICIENCY" },
                    { pos: [3, -5, -3], text: "POLITICAL CYCLES" },
                    { pos: [-3, -8, 2], text: "MEDICAL MODEL" },
                    { pos: [3, -7.5, -2], text: "CURE VS CARE" },
                    { pos: [0, -9, 1], text: "PATERNALISM" },
                    { pos: [-4, -8.5, -1], text: "SHORT-TERMISM" }
                ]
            },
            reef: {
                title: "The Tensegrity Lattice",
                dot: "#10b981",
                desc: "The core tension between statutory, financially accountable ICBs (Order) and diverse, strategic ICPs (Chaos). The 'Place' level is where these forces collide, often creating a democratic deficit.",
                stats: [
                    { label: "Statutory", val: "ICB Finance" },
                    { label: "Strategic", val: "ICP Strategy" }
                ],
                hud: [
                    { pos: [0, 5, 0], text: "INTEGRATED CARE BOARD", sub: "Statutory Control" },
                    { pos: [0, -5, 0], text: "INTEGRATED CARE PARTNERSHIP", sub: "Strategic Alliance" },
                    { pos: [0, 0, 0], text: "PLACE-BASED TENSION", sub: "Power Dynamic" }
                ],
                clusters: [
                    { pos: [2, 6, 2], text: "STATUTORY DOMINANCE" },
                    { pos: [-2, 5.5, -2], text: "NHS ENGLAND OVERSIGHT" },
                    { pos: [-5, 0, 3], text: "DEMOCRATIC DEFICIT" },
                    { pos: [5, 0, -3], text: "MUTUAL ACCOUNTABILITY" },
                    { pos: [-4, -4, -3], text: "ANCHOR INSTITUTIONS" },
                    { pos: [4, -5, 2], text: "PROVIDER COLLABORATIVES" },
                    { pos: [0, -2, 4], text: "DELEGATED BUDGETS" },
                    { pos: [0, 2, -4], text: "SYSTEM CONTROL TOTAL" }
                ]
            },
            dynamics: {
                title: "The Entropy Vortex",
                dot: "#f59e0b",
                desc: "The 'Agency Spend Trap' is a reinforcing loop. Burnout creates vacancies, forcing expensive Agency use, which drains retention budgets, causing further burnout and 'Moral Injury'.",
                stats: [
                    { label: "Entropy", val: "Accelerating", id: "sim-state" },
                    { label: "Workforce", val: "1.4m", id: "sim-val" }
                ],
                hud: [
                    { pos: [-6, 3, 0], text: "RECRUITMENT (INFLOW)", sub: "International Pipeline" },
                    { pos: [6, -3, 0], text: "AGENCY VORTEX (LEAK)", sub: "Premium Cost" }
                ],
                clusters: [
                    { pos: [-8, 4, 2], text: "INTERNATIONAL RECRUITMENT" },
                    { pos: [-5, 2, -2], text: "BANK STAFF" },
                    { pos: [-7, 5, -1], text: "TRAINING LAG" },
                    { pos: [7, -2, 2], text: "AGENCY PREMIUM" },
                    { pos: [5, -5, -2], text: "MORAL INJURY" },
                    { pos: [8, -4, 1], text: "ROTA GAPS" },
                    { pos: [6, 0, -3], text: "CONTINUITY OF CARE" },
                    { pos: [4, -1, 3], text: "PENSION TAXATION" }
                ]
            },
            pfi: {
                title: "The Inflationary Squeeze",
                dot: "#ef4444",
                desc: "Unitary Charges are peaking (2025-2030). RPI-linked debt behaves like a living organism, swelling with inflation and squeezing the 'Service Floor' of clinical care.",
                stats: [
                    { label: "Peak Charge", val: "£2.5bn / yr" },
                    { label: "Linkage", val: "RPI + Inflation" }
                ],
                hud: [
                    { pos: [-5, 8, 0], text: "UNITARY CHARGE PEAK", sub: "2025-2035 Horizon" },
                    { pos: [5, 1, 0], text: "SERVICE FLOOR", sub: "Clinical Budget" }
                ],
                clusters: [
                    { pos: [-6, 9, 2], text: "RPI LINKAGE" },
                    { pos: [-2, 8, -2], text: "HARD FM COSTS" },
                    { pos: [-5, 7, -1], text: "LIFECYCLE REPLACEMENT" },
                    { pos: [7, 0, 1], text: "CLINICAL SQUEEZE" },
                    { pos: [4, 1, -1], text: "BALANCE SHEET TREATMENT" },
                    { pos: [6, 3, 2], text: "CONTRACT EXPIRY" },
                    { pos: [5, 2, -2], text: "PF2 LEGACY" }
                ]
            }
        };

        // --- Core UI Logic ---
        function togglePanel(e) {
            if (e) e.stopPropagation();
            const panel = document.getElementById('info-panel');
            const chevron = document.getElementById('chevron');
            panel.classList.toggle('collapsed');
            chevron.style.transform = panel.classList.contains('collapsed') ? 'rotate(180deg)' : 'rotate(0deg)';
        }

        function expandPanel() {
            const panel = document.getElementById('info-panel');
            if (panel.classList.contains('collapsed')) togglePanel();
        }

        // --- Three.js Setup ---
        const scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x020617, 0.02);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        document.body.appendChild(renderer.domElement);

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.enableZoom = true;
        controls.enablePan = true;
        controls.minDistance = 5;
        controls.maxDistance = 50;

        const mainGroup = new THREE.Group();
        scene.add(mainGroup);

        // Lighting
        scene.add(new THREE.AmbientLight(0x475569, 0.4));
        const spotlight = new THREE.SpotLight(0x3b82f6, 5);
        spotlight.position.set(10, 20, 10);
        spotlight.angle = 0.5;
        spotlight.penumbra = 1;
        scene.add(spotlight);

        const rimLight = new THREE.PointLight(0x60a5fa, 2);
        rimLight.position.set(-10, 5, -10);
        scene.add(rimLight);

        // Background Particles
        const partGeo = new THREE.BufferGeometry();
        const partCount = 500;
        const posArray = new Float32Array(partCount * 3);
        for (let i = 0; i < partCount * 3; i++) {
            posArray[i] = (Math.random() - 0.5) * 60;
        }
        partGeo.setAttribute('position', new THREE.BufferAttribute(posArray, 3));
        const stars = new THREE.Points(partGeo, new THREE.PointsMaterial({
            size: 0.05, color: 0x94a3b8, transparent: true, opacity: 0.4
        }));
        scene.add(stars);

        // --- Sim State ---
        let simParams = { stock: 60, recruitment: 50, pressure: 20, attritionBase: 40 };
        let currentId = 'iceberg';
        let rotationY = 0;
        let rotationX = 0;

        // --- HUD Generator ---
        function updateHUD() {
            const container = document.getElementById('hud-container');
            container.innerHTML = '';

            const data = systemData[currentId];
            if (!data.hud) return;

            // Render Main HUD Elements
            data.hud.forEach(item => {
                createLabel(container, item, 'main');
            });

            // Render Cluster Elements if they exist
            if (data.clusters) {
                data.clusters.forEach(item => {
                    createLabel(container, item, 'cluster');
                });
            }
        }

        function createLabel(container, item, type) {
            const vector = new THREE.Vector3(...item.pos);
            // Apply group rotation to vector
            vector.applyQuaternion(mainGroup.quaternion);
            vector.project(camera);

            const x = (vector.x * .5 + .5) * window.innerWidth;
            const y = (vector.y * -.5 + .5) * window.innerHeight;

            if (vector.z < 1) {
                const el = document.createElement('div');
                el.className = 'hud-label flex flex-col items-center text-center';
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;

                if (type === 'main') {
                    el.innerHTML = `
                        <div class="w-1 h-8 bg-blue-500/50 mb-2"></div>
                        <div class="bg-slate-900/80 p-2 rounded border border-white/10 backdrop-blur-md">
                            <div class="text-[10px] font-black text-white whitespace-nowrap tracking-widest uppercase">${item.text}</div>
                            <div class="text-[8px] text-blue-400 font-bold uppercase">${item.sub}</div>
                        </div>
                    `;
                } else {
                    // Simpler style for clusters
                    el.innerHTML = `
                        <div class="text-[9px] font-bold text-slate-300/60 bg-slate-900/40 px-2 py-1 rounded backdrop-blur-sm border border-white/5 whitespace-nowrap">${item.text}</div>
                    `;
                    el.style.zIndex = 5;
                }
                container.appendChild(el);
            }
        }

        // --- Scene Builders ---
        function buildIceberg() {
            mainGroup.clear();

            // Tip: Low Poly Crystal
            const iceMat = new THREE.MeshPhysicalMaterial({
                color: 0xe2e8f0,
                metalness: 0.1,
                roughness: 0.2,
                clearcoat: 1,
                transmission: 0.2,
                transparent: true,
                flatShading: true
            });
            const tipGeo = new THREE.ConeGeometry(3.5, 5, 5);
            const tip = new THREE.Mesh(tipGeo, iceMat);
            tip.position.y = 2.5;
            mainGroup.add(tip);

            // Base: Wireframe Volume representing Mental Models
            const baseGeo = new THREE.IcosahedronGeometry(7, 1);
            const baseMat = new THREE.MeshBasicMaterial({
                color: 0x3b82f6,
                wireframe: true,
                transparent: true,
                opacity: 0.15
            });
            const base = new THREE.Mesh(baseGeo, baseMat);
            base.position.y = -6;
            base.rotation.x = Math.PI;

            // Inner Glow for Base
            const innerBase = new THREE.Mesh(
                new THREE.IcosahedronGeometry(6, 0),
                new THREE.MeshBasicMaterial({ color: 0x1e40af, transparent: true, opacity: 0.1 })
            );
            base.add(innerBase);
            mainGroup.add(base);

            // Water Plane
            const plane = new THREE.Mesh(
                new THREE.PlaneGeometry(60, 60),
                new THREE.MeshPhongMaterial({
                    color: 0x0f172a,
                    transparent: true,
                    opacity: 0.8,
                    shininess: 100,
                    side: THREE.DoubleSide
                })
            );
            plane.rotation.x = Math.PI / 2;
            mainGroup.add(plane);
        }

        function buildReef() {
            mainGroup.clear();

            // 1. Central ICB Crystal (Order/Statutory)
            const icbGeo = new THREE.OctahedronGeometry(2, 0);
            const icbMat = new THREE.MeshPhysicalMaterial({
                color: 0x10b981,
                metalness: 0.9,
                roughness: 0.1,
                clearcoat: 1,
                emissive: 0x064e3b,
                emissiveIntensity: 0.5
            });
            const icb = new THREE.Mesh(icbGeo, icbMat);
            mainGroup.add(icb);

            // 2. Surrounding ICP Cloud (Chaos/Strategic)
            const icpCount = 30;
            const icpNodes = [];
            const cloudRadius = 8;

            for (let i = 0; i < icpCount; i++) {
                // Diverse shapes for diverse partners
                let geo;
                const r = Math.random();
                if (r > 0.6) geo = new THREE.TetrahedronGeometry(0.5);
                else if (r > 0.3) geo = new THREE.IcosahedronGeometry(0.4);
                else geo = new THREE.DodecahedronGeometry(0.4);

                const mat = new THREE.MeshLambertMaterial({
                    color: Math.random() > 0.5 ? 0x34d399 : 0x6ee7b7,
                    transparent: true,
                    opacity: 0.8
                });

                const mesh = new THREE.Mesh(geo, mat);

                // Random spherical distribution
                const phi = Math.acos(-1 + (2 * i) / icpCount);
                const theta = Math.sqrt(icpCount * Math.PI) * phi;

                mesh.position.setFromSphericalCoords(cloudRadius + (Math.random() - 0.5) * 2, phi, theta);
                mesh.rotation.set(Math.random() * Math.PI, Math.random() * Math.PI, 0);

                mainGroup.add(mesh);
                icpNodes.push(mesh);
            }

            // 3. Tensegrity Stress Lines (Tension)
            const lineMat = new THREE.LineBasicMaterial({ color: 0x059669, transparent: true, opacity: 0.15 });
            const tensionPoints = [];

            icpNodes.forEach(node => {
                // Connect every ICP node to the Center (Statutory Tether)
                tensionPoints.push(node.position);
                tensionPoints.push(new THREE.Vector3(0, 0, 0));

                // Connect to nearest neighbor (Strategic Alliance)
                let nearest = null;
                let minDst = Infinity;
                icpNodes.forEach(other => {
                    if (node === other) return;
                    const d = node.position.distanceTo(other.position);
                    if (d < minDst) { minDst = d; nearest = other; }
                });

                if (nearest && minDst < 4) {
                    tensionPoints.push(node.position);
                    tensionPoints.push(nearest.position);
                }
            });

            const lineGeo = new THREE.BufferGeometry().setFromPoints(tensionPoints);
            const lines = new THREE.LineSegments(lineGeo, lineMat);
            mainGroup.add(lines);
        }

        function buildDynamics() {
            mainGroup.clear();

            // 1. The Tank (Leaky Bucket Metaphor)
            const tankGeo = new THREE.CylinderGeometry(4.5, 4, 9, 32, 1, true);
            const tankMat = new THREE.MeshPhysicalMaterial({
                color: 0xffffff,
                metalness: 0.1,
                roughness: 0.05,
                transmission: 0.95,
                thickness: 0.5,
                transparent: true,
                opacity: 0.4,
                side: THREE.DoubleSide
            });
            const tank = new THREE.Mesh(tankGeo, tankMat);
            mainGroup.add(tank);

            // Rim
            const rim = new THREE.Mesh(new THREE.TorusGeometry(4.5, 0.1, 8, 32), new THREE.MeshStandardMaterial({ color: 0x94a3b8 }));
            rim.rotation.x = Math.PI / 2;
            rim.position.y = 4.5;
            mainGroup.add(rim);

            // 2. Liquid Vortex (Base mass)
            const waterGeo = new THREE.CylinderGeometry(4.3, 3.8, 1, 32);
            waterGeo.translate(0, 0.5, 0); // Pivot at bottom
            const waterMat = new THREE.MeshPhysicalMaterial({
                color: 0x3b82f6,
                transparent: true,
                opacity: 0.6,
                roughness: 0.2,
                transmission: 0.4
            });
            const water = new THREE.Mesh(waterGeo, waterMat);
            water.name = "water";
            water.position.y = -4.5;
            mainGroup.add(water);

            // 3. Entropy Particles (Staff)
            const pCount = 800;
            const pos = new Float32Array(pCount * 3);
            const colors = new Float32Array(pCount * 3);
            const sizes = new Float32Array(pCount);

            const colorPerm = new THREE.Color(0x3b82f6);
            const colorTemp = new THREE.Color(0xf43f5e);

            for (let i = 0; i < pCount; i++) {
                const r = (Math.random() * 4);
                const theta = Math.random() * Math.PI * 2;
                const y = (Math.random() - 0.5) * 8;

                pos[i * 3] = r * Math.cos(theta);
                pos[i * 3 + 1] = y;
                pos[i * 3 + 2] = r * Math.sin(theta);

                // 20% Agency (Red), 80% Permanent (Blue) initially
                const isAgency = Math.random() > 0.8;
                const col = isAgency ? colorTemp : colorPerm;

                colors[i * 3] = col.r;
                colors[i * 3 + 1] = col.g;
                colors[i * 3 + 2] = col.b;

                sizes[i] = isAgency ? 0.15 : 0.08;
            }

            const pGeo = new THREE.BufferGeometry();
            pGeo.setAttribute('position', new THREE.BufferAttribute(pos, 3));
            pGeo.setAttribute('color', new THREE.BufferAttribute(colors, 3));
            pGeo.setAttribute('size', new THREE.BufferAttribute(sizes, 1));

            // Custom shader material for particles would be ideal, but standard points is safer for now
            const pMat = new THREE.PointsMaterial({
                vertexColors: true,
                size: 0.1,
                transparent: true,
                opacity: 0.8
            });

            const particles = new THREE.Points(pGeo, pMat);
            particles.name = "entropyParticles";
            water.add(particles); // Add to water so they move with it (mostly)

            // 4. Inflow Pipe
            const pipe = new THREE.Mesh(
                new THREE.CylinderGeometry(0.5, 0.5, 4, 16),
                new THREE.MeshStandardMaterial({ color: 0x64748b })
            );
            pipe.position.set(0, 7, 0);
            mainGroup.add(pipe);
        }

        function buildPFI() {
            mainGroup.clear();

            // SHERWOOD FOREST HOSPITALS DATA
            // Total cost forecast: £2.5bn
            // Annual payment: ~£53.8m / yr

            // 1. The Buckling Floor (Clinical Budget)
            const floorGeo = new THREE.PlaneGeometry(30, 15, 20, 10);
            const pos = floorGeo.attributes.position;

            for (let i = 0; i < pos.count; i++) {
                const x = pos.getX(i);
                const distToPFI = Math.abs(x - 6);
                const dip = Math.max(0, 4 - distToPFI * 0.6); // Deeper dip to represent £2.5bn debt

                pos.setZ(i, -dip + (Math.random() - 0.5) * 0.2);
            }
            floorGeo.computeVertexNormals();

            const floorMat = new THREE.MeshStandardMaterial({
                color: 0x475569,
                roughness: 0.8,
                wireframe: true,
                transparent: true,
                opacity: 0.2
            });
            const floor = new THREE.Mesh(floorGeo, floorMat);
            floor.rotation.x = -Math.PI / 2;
            floor.position.y = -2;
            mainGroup.add(floor);

            // 2. The PFI Tower (Sherwood Forest)
            const pfiGroup = new THREE.Group();
            pfiGroup.position.set(6, 0, 0);

            // Concrete Capital (The Hospital)
            const fCap = new THREE.Mesh(
                new THREE.BoxGeometry(4, 3, 4),
                new THREE.MeshStandardMaterial({ color: 0x64748b })
            );
            fCap.position.y = 1.5;
            pfiGroup.add(fCap);

            // Services & Maintenance (Inflated)
            const fServ = new THREE.Mesh(
                new THREE.BoxGeometry(4.2, 4, 4.2),
                new THREE.MeshStandardMaterial({ color: 0x3b82f6, transparent: true, opacity: 0.6 })
            );
            fServ.position.y = 5;
            pfiGroup.add(fServ);

            // DEBT SPIRE (The Financial Reality)
            // Represents the £2.5bn total vs original cost
            // 7x height relative to capital roughly
            const fFinGeo = new THREE.CylinderGeometry(2.5, 2, 12, 8);
            const fFinMat = new THREE.MeshPhysicalMaterial({
                color: 0xef4444,
                emissive: 0x7f1d1d,
                emissiveIntensity: 0.8,
                metalness: 0.9,
                roughness: 0.1,
                clearcoat: 1
            });
            const fFin = new THREE.Mesh(fFinGeo, fFinMat);
            fFin.position.y = 13;
            fFin.name = "pfi_debt";
            pfiGroup.add(fFin);

            // Data Label: Annual Charge
            const chLabel = create3DLabel("£53.8m / YR", 0xffffff);
            chLabel.position.y = 8;
            chLabel.scale.set(6, 1.5, 1);
            pfiGroup.add(chLabel);

            // Data Label: Total Forecast
            const totLabel = create3DLabel("£2.5 BILLION FORECAST", 0xef4444);
            totLabel.position.y = 20;
            totLabel.scale.set(10, 2.5, 1);
            pfiGroup.add(totLabel);

            mainGroup.add(pfiGroup);

            // 3. Comparison Context (Normal Trust)
            const pubGroup = new THREE.Group();
            pubGroup.position.set(-8, 0, 0);

            const pCap = new THREE.Mesh(
                new THREE.BoxGeometry(3, 2, 3),
                new THREE.MeshStandardMaterial({ color: 0x64748b })
            ); // Smaller scale
            pCap.position.y = 1;
            pubGroup.add(pCap);

            const pLabel = create3DLabel("STANDARD MODEL", 0xa1a1aa);
            pLabel.position.y = 3;
            pubGroup.add(pLabel);

            mainGroup.add(pubGroup);
        }

        function create3DLabel(text, color) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256;
            canvas.height = 64;
            ctx.fillStyle = `rgba(0,0,0,0)`;
            ctx.fillRect(0, 0, 256, 64);
            ctx.fillStyle = '#' + new THREE.Color(color).getHexString();
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText(text, 128, 40);

            const tex = new THREE.CanvasTexture(canvas);
            const mat = new THREE.SpriteMaterial({ map: tex });
            const sprite = new THREE.Sprite(mat);
            sprite.scale.set(8, 2, 1);
            return sprite;
        }

        // --- Simulation Core ---
        function runSimulation() {
            if (currentId !== 'dynamics') return;

            // System Dynamics Logic: Reinforcing Loop
            // As stock drops, attrition increases exponentially (Pressure feedback)
            const pressureFactor = (100 - simParams.stock) / 50;
            const dynamicAttrition = (simParams.attritionBase + (simParams.pressure * pressureFactor)) * 0.01;
            const dynamicRecruitment = simParams.recruitment * 0.01;

            const netFlow = dynamicRecruitment - dynamicAttrition;
            simParams.stock += netFlow * 0.5;
            simParams.stock = Math.max(5, Math.min(simParams.stock, 100));

            // Alert logic
            const alert = document.getElementById('cycle-alert');
            if (simParams.stock < 35) {
                alert.classList.remove('hidden');
                alert.className = "status-pill vicious-cycle";
                alert.innerText = "Burnout Reinforcing Loop";
            } else {
                alert.classList.add('hidden');
            }

            // Visual Update
            const water = mainGroup.getObjectByName('water');
            if (water) {
                water.scale.y = simParams.stock / 10;
                water.position.y = (simParams.stock / 10) / 2 - 4.5; // Adjusted for new tank height
                water.material.color.setHSL(0.6, 0.8, simParams.stock / 150 + 0.2);

                // Animate Entropy Particles
                const particles = water.getObjectByName('entropyParticles');
                if (particles) {
                    const pos = particles.geometry.attributes.position;
                    const count = pos.count;
                    for (let i = 0; i < count; i++) {
                        const x = pos.getX(i);
                        const z = pos.getZ(i);
                        // Vortex rotation speed inversely proportional to stock (Chaos increases as stock drops)
                        const speed = 0.02 + ((100 - simParams.stock) / 2000);
                        const cos = Math.cos(speed);
                        const sin = Math.sin(speed);

                        pos.setX(i, x * cos - z * sin);
                        pos.setZ(i, x * sin + z * cos);
                    }
                    pos.needsUpdate = true;
                }
            }

            document.getElementById('sim-val').innerText = `${Math.floor(simParams.stock * 28000).toLocaleString()} FTE`;
            document.getElementById('sim-state').innerText = netFlow > 0 ? "Resilient" : "Fragile";
        }

        function switchScene(id) {
            currentId = id;
            const data = systemData[id];

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${id}`).classList.add('active');

            document.getElementById('scene-dot').style.backgroundColor = data.dot;
            document.getElementById('scene-dot').style.boxShadow = `0 0 15px ${data.dot}`;
            document.getElementById('scene-title').innerText = data.title;
            document.getElementById('scene-desc').innerText = data.desc;

            const stats = document.getElementById('data-stats');
            stats.innerHTML = data.stats.map(s => `
                <div>
                    <div class="text-[9px] font-black text-slate-500 uppercase">${s.label}</div>
                    <div id="${s.id || ''}" class="text-sm font-bold text-white font-mono">${s.val}</div>
                </div>
            `).join('');

            document.getElementById('controls-panel').style.display = id === 'dynamics' ? 'block' : 'none';

            if (id === 'iceberg') buildIceberg();
            if (id === 'reef') buildReef();
            if (id === 'dynamics') buildDynamics();
            if (id === 'pfi') buildPFI();
        }

        // --- Controls ---
        window.addEventListener('mousemove', (e) => {
            rotationY = ((e.clientX / window.innerWidth) * 2 - 1) * 0.4;
            rotationX = ((e.clientY / window.innerHeight) * 2 - 1) * 0.2;
        });

        document.getElementById('slider-rec').addEventListener('input', e => {
            simParams.recruitment = parseInt(e.target.value);
            document.getElementById('val-rec').innerText = `${e.target.value}%`;
        });

        document.getElementById('slider-pres').addEventListener('input', e => {
            simParams.pressure = parseInt(e.target.value);
            document.getElementById('val-pres').innerText = e.target.value > 70 ? "CRITICAL" : (e.target.value > 40 ? "HIGH" : "LOW");
        });

        function animate() {
            requestAnimationFrame(animate);
            mainGroup.rotation.y += (rotationY - mainGroup.rotation.y) * 0.05;
            mainGroup.rotation.x += (rotationX - mainGroup.rotation.x) * 0.05;

            camera.position.z = 20;
            camera.lookAt(0, 0, 0);

            runSimulation();
            updateHUD();

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        window.onload = () => {
            switchScene('iceberg');
            animate();
        };
    </script>
</body>

</html>