<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health IP Ecosystem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Courier New', monospace;
            color: white;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* UI Overlay */
        #ui-layer {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .pointer-auto {
            pointer-events: auto;
        }

        .glass-btn {
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            color: #888;
            padding: 8px 16px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .glass-btn:hover {
            border-color: #fff;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
        }

        .glass-btn.active {
            border-color: #2dd4bf;
            color: #2dd4bf;
            background: rgba(45, 212, 191, 0.1);
        }

        /* Status Bar */
        .bar-bg {
            width: 100%;
            height: 4px;
            background: #222;
            margin-top: 8px;
        }

        .bar-fill {
            height: 100%;
            background: #f59e0b;
            width: 100%;
            transition: width 0.3s ease, background 0.3s ease;
            box-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        /* Loading */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>

    <div id="loader">
        <div class="text-teal-500 font-bold tracking-widest animate-pulse">INITIALIZING CORE...</div>
        <div id="debug-log" class="text-red-500 text-xs mt-4"></div>
    </div>

    <div id="canvas-container"></div>

    <div id="ui-layer" class="flex flex-col justify-between p-6">
        <!-- Top Left -->
        <div class="pointer-auto max-w-xs">
            <h1 class="text-xl font-bold text-white tracking-tighter">HEALTH_IP <span class="text-teal-500">//</span>
                SIM</h1>
            <div class="text-[10px] text-gray-500 mt-1">
                BALANCING PROTOCOL: ACTIVE
            </div>

            <div class="mt-4 bg-black/50 border border-gray-800 p-3 backdrop-blur-sm">
                <div class="flex justify-between text-[10px] text-gray-400">
                    <span>SYSTEM STABILITY</span>
                    <span id="score-text">100%</span>
                </div>
                <div class="bar-bg">
                    <div id="stability-bar" class="bar-fill"></div>
                </div>
                <div id="msg-log" class="text-[10px] text-teal-400 mt-2 h-4 font-bold">>> SYSTEM READY</div>
            </div>
        </div>

        <!-- Bottom Controls -->
        <div class="pointer-auto self-center flex flex-col items-center w-full max-w-4xl gap-4">
            <!-- Mode Selector -->
            <div class="flex gap-2">
                <button id="btn-public" class="glass-btn" onclick="app.setMode('public')">Public</button>
                <button id="btn-dpg" class="glass-btn active" onclick="app.setMode('dpg')">DPG Infra</button>
                <button id="btn-latent" class="glass-btn" onclick="app.setMode('latent')">Latent Bridge</button>
                <button id="btn-private" class="glass-btn" onclick="app.setMode('private')">Private</button>
            </div>

            <!-- Asset List -->
            <div id="asset-list" class="flex gap-2 overflow-x-auto w-full justify-center pb-2">
                <!-- Injected via JS -->
            </div>
        </div>
    </div>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <!-- Main Application Script -->
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import * as CANNON from 'https://unpkg.com/cannon-es@0.20.0/dist/cannon-es.js';

        // --- Data Model ---
        const ASSETS = {
            public: [
                { name: 'NHS Data', mass: 8, color: 0x3b82f6, desc: 'High Value / Privacy Risk' },
                { name: 'Governance', mass: 5, color: 0x60a5fa, desc: 'Regulatory Oversight' },
                { name: 'Trust', mass: 4, color: 0x93c5fd, desc: 'Social License' }
            ],
            private: [
                { name: 'Venture Cap', mass: 6, color: 0xec4899, desc: 'Growth Capital' },
                { name: 'H100 GPU', mass: 5, color: 0xd946ef, desc: 'Compute Power' },
                { name: 'Closed IP', mass: 7, color: 0xc026d3, desc: 'Proprietary Tech' }
            ],
            dpg: [
                { name: 'Open Weights', mass: 1, color: 0x2dd4bf, desc: 'Lightweight / High Grip', friction: 1.0 },
                { name: 'FHIR Std', mass: 1, color: 0x14b8a6, desc: 'Interoperability', friction: 0.9 },
                { name: 'Synth Data', mass: 0.5, color: 0x5eead4, desc: 'Privacy Safe', friction: 0.8 }
            ],
            latent: [
                { name: 'Fed. Learning', mass: 2, color: 0xf59e0b, desc: '+Stability Boost', stable: 15 },
                { name: 'TRE Box', mass: 3, color: 0xd97706, desc: '+Security Layer', stable: 10 }
            ]
        };

        class App {
            constructor() {
                this.objects = [];
                this.stability = 100;
                this.isCollapsed = false;
                this.currentMode = 'dpg';
                this.init();
            }

            init() {
                try {
                    // 1. Scene
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0x050505);
                    this.scene.fog = new THREE.FogExp2(0x050505, 0.02);

                    // 2. Camera
                    this.camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
                    this.camera.position.set(0, 15, 35);
                    this.camera.lookAt(0, 0, 0);

                    // 3. Renderer
                    this.renderer = new THREE.WebGLRenderer({ antialias: true });
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.renderer.shadowMap.enabled = true;
                    document.getElementById('canvas-container').appendChild(this.renderer.domElement);

                    // 4. Lights
                    const ambient = new THREE.AmbientLight(0xffffff, 0.3);
                    this.scene.add(ambient);

                    const dirLight = new THREE.DirectionalLight(0xffffff, 1);
                    dirLight.position.set(10, 20, 10);
                    dirLight.castShadow = true;
                    dirLight.shadow.mapSize.width = 2048;
                    dirLight.shadow.mapSize.height = 2048;
                    this.scene.add(dirLight);

                    // Rim lights
                    const l1 = new THREE.PointLight(0x3b82f6, 50, 50); l1.position.set(-15, 10, 0); this.scene.add(l1);
                    const l2 = new THREE.PointLight(0xec4899, 50, 50); l2.position.set(15, 10, 0); this.scene.add(l2);

                    // 5. Physics
                    this.world = new CANNON.World();
                    this.world.gravity.set(0, -9.81, 0);
                    this.world.broadphase = new CANNON.SAPBroadphase(this.world);

                    // Physics Materials
                    this.matDefault = new CANNON.Material('default');
                    this.matSticky = new CANNON.Material('sticky');

                    this.world.addContactMaterial(new CANNON.ContactMaterial(this.matDefault, this.matDefault, { friction: 0.3, restitution: 0.1 }));
                    this.world.addContactMaterial(new CANNON.ContactMaterial(this.matSticky, this.matDefault, { friction: 1.5, restitution: 0 }));
                    this.world.addContactMaterial(new CANNON.ContactMaterial(this.matSticky, this.matSticky, { friction: 2.0, restitution: 0 }));

                    // 6. Build Stage
                    this.buildStage();

                    // 7. Controls
                    this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                    this.controls.enableDamping = true;
                    this.controls.maxPolarAngle = Math.PI / 2 - 0.1;

                    // 8. Start Loop
                    window.addEventListener('resize', () => this.onResize());
                    this.animate();

                    // 9. UI Init
                    this.setMode('dpg');

                    // Hide loader
                    document.getElementById('loader').style.opacity = 0;
                    setTimeout(() => document.getElementById('loader').style.display = 'none', 500);

                } catch (e) {
                    console.error(e);
                    document.getElementById('debug-log').innerText = "CRITICAL ERROR: " + e.message;
                }
            }

            buildStage() {
                // Floor
                const grid = new THREE.GridHelper(100, 50, 0x333333, 0x111111);
                grid.position.set(0, -5, 0);
                this.scene.add(grid);

                const floorBody = new CANNON.Body({ mass: 0, shape: new CANNON.Plane() });
                floorBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
                floorBody.position.set(0, -5, 0);
                this.world.addBody(floorBody);

                // --- The Board ---
                const w = 24, h = 0.5, d = 6;

                // Visual
                const geo = new THREE.BoxGeometry(w, h, d);
                const mat = new THREE.MeshStandardMaterial({ color: 0x1e293b, roughness: 0.1, metalness: 0.5 });
                this.boardMesh = new THREE.Mesh(geo, mat);
                this.boardMesh.castShadow = true;
                this.boardMesh.receiveShadow = true;

                // Add "Neon" edges
                const edges = new THREE.EdgesGeometry(geo);
                const line = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: 0x2dd4bf }));
                this.boardMesh.add(line);

                this.scene.add(this.boardMesh);

                // Physics
                this.boardBody = new CANNON.Body({
                    mass: 50,
                    shape: new CANNON.Box(new CANNON.Vec3(w / 2, h / 2, d / 2)),
                    position: new CANNON.Vec3(0, 0, 0),
                    material: this.matDefault
                });
                this.world.addBody(this.boardBody);
                this.objects.push({ m: this.boardMesh, b: this.boardBody });

                // Pivot
                const pivot = new CANNON.Body({ mass: 0 });
                pivot.position.set(0, -1, 0);
                this.world.addBody(pivot);

                // Hinge
                const hinge = new CANNON.HingeConstraint(this.boardBody, pivot, {
                    pivotA: new CANNON.Vec3(0, -1, 0),
                    pivotB: new CANNON.Vec3(0, 0, 0),
                    axisA: new CANNON.Vec3(0, 0, 1),
                    axisB: new CANNON.Vec3(0, 0, 1)
                });
                this.world.addConstraint(hinge);

                // Visual Fulcrum
                this.pivotMesh = new THREE.Mesh(
                    new THREE.ConeGeometry(2, 3, 4),
                    new THREE.MeshBasicMaterial({ color: 0xf59e0b, wireframe: true })
                );
                this.pivotMesh.position.set(0, -2, 0);
                this.pivotMesh.rotation.y = Math.PI / 4;
                this.scene.add(this.pivotMesh);
            }

            spawn(mode, index) {
                if (this.isCollapsed) return;
                const data = ASSETS[mode][index];

                // 1. Position Logic
                let x = 0;
                if (mode === 'public') x = -5 - Math.random() * 4;
                else if (mode === 'private') x = 5 + Math.random() * 4;
                else x = (Math.random() - 0.5) * 3;

                // 2. Create Object
                const size = 1 + (data.mass * 0.1);

                let geo = new THREE.BoxGeometry(size, size, size);
                let mat;

                if (mode === 'dpg') {
                    mat = new THREE.MeshBasicMaterial({ color: data.color, wireframe: true });
                } else {
                    mat = new THREE.MeshStandardMaterial({
                        color: 0x111111,
                        emissive: data.color,
                        emissiveIntensity: 0.5,
                        roughness: 0.2
                    });
                }

                const mesh = new THREE.Mesh(geo, mat);
                mesh.castShadow = true;
                this.scene.add(mesh);

                // 3. Physics
                const matPhys = (mode === 'dpg' || data.friction > 0.5) ? this.matSticky : this.matDefault;
                const body = new CANNON.Body({
                    mass: data.mass,
                    shape: new CANNON.Box(new CANNON.Vec3(size / 2, size / 2, size / 2)),
                    position: new CANNON.Vec3(x, 10, (Math.random() - 0.5) * 2),
                    material: matPhys
                });

                // Random spin
                body.angularVelocity.set(Math.random(), Math.random(), Math.random());

                this.world.addBody(body);
                this.objects.push({ m: mesh, b: body });

                // 4. Update Stats
                if (data.stable) {
                    this.stability = Math.min(100, this.stability + data.stable);
                    this.log(`STABILITY RESTORED: +${data.stable}%`);

                    // Visual pulse
                    this.pivotMesh.scale.set(1.5, 1.5, 1.5);
                    setTimeout(() => this.pivotMesh.scale.set(1, 1, 1), 300);
                } else {
                    this.stability = Math.max(0, this.stability - 3);
                    this.log(`DEPLOYED: ${data.name}`);
                }
                this.updateUI();
            }

            animate() {
                requestAnimationFrame(() => this.animate());

                try {
                    this.world.step(1 / 60);

                    // Latent Force Logic
                    if (!this.isCollapsed && this.boardBody) {
                        const angle = this.boardBody.quaternion.toEuler().z;

                        // Corrective torque based on Stability Score
                        const force = -angle * (this.stability * 12);
                        this.boardBody.torque.z += force;

                        // Visual rotation
                        if (this.pivotMesh) this.pivotMesh.rotation.y += 0.01;

                        if (Math.abs(angle) > 0.6) {
                            this.isCollapsed = true;
                            this.log("SYSTEM FAILURE // IMBALANCE");
                            document.getElementById('stability-bar').style.backgroundColor = 'red';
                        }
                    }

                    // Sync
                    this.objects.forEach(o => {
                        o.m.position.copy(o.b.position);
                        o.m.quaternion.copy(o.b.quaternion);
                    });

                    this.controls.update();
                    this.renderer.render(this.scene, this.camera);
                } catch (e) {
                    console.error("Frame Error:", e);
                }
            }

            log(msg) {
                const el = document.getElementById('msg-log');
                el.innerText = `>> ${msg}`;
                el.style.opacity = 1;
                setTimeout(() => el.style.opacity = 0.5, 2000);
            }

            updateUI() {
                const bar = document.getElementById('stability-bar');
                bar.style.width = this.stability + '%';
                document.getElementById('score-text').innerText = this.stability + '%';

                if (this.stability < 30) bar.style.backgroundColor = '#ef4444'; // Red
                else if (this.stability < 60) bar.style.backgroundColor = '#f59e0b'; // Amber
                else bar.style.backgroundColor = '#f59e0b'; // Teal/Amber mix visual
            }

            onResize() {
                this.camera.aspect = window.innerWidth / window.innerHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(window.innerWidth, window.innerHeight);
            }

            setMode(mode) {
                this.currentMode = mode;
                // Buttons
                ['public', 'dpg', 'latent', 'private'].forEach(key => {
                    const btn = document.getElementById(`btn-${key}`);
                    if (key === mode) btn.classList.add('active');
                    else btn.classList.remove('active');
                });

                // Asset Row
                const cont = document.getElementById('asset-list');
                cont.innerHTML = '';
                ASSETS[mode].forEach((item, i) => {
                    const el = document.createElement('div');
                    el.className = "flex-shrink-0 cursor-pointer bg-slate-900 border border-slate-700 hover:border-white p-2 w-28 rounded group transition-all";
                    el.onclick = () => this.spawn(mode, i);

                    const hex = '#' + item.color.toString(16);
                    el.innerHTML = `
                        <div class="w-full h-1 mb-2 rounded" style="background:${hex}; box-shadow: 0 0 5px ${hex}"></div>
                        <div class="text-[10px] font-bold text-white group-hover:text-teal-400">${item.name}</div>
                        <div class="text-[9px] text-gray-500">${item.desc}</div>
                    `;
                    cont.appendChild(el);
                });
            }
        }

        // Cannon Euler Helper
        CANNON.Quaternion.prototype.toEuler = function () {
            let heading, attitude, bank;
            const q = this;
            const test = q.x * q.y + q.z * q.w;
            if (test > 0.499) { heading = 2 * Math.atan2(q.x, q.w); attitude = Math.PI / 2; bank = 0; }
            if (test < -0.499) { heading = -2 * Math.atan2(q.x, q.w); attitude = -Math.PI / 2; bank = 0; }
            if (isNaN(heading)) {
                const sqx = q.x * q.x; const sqy = q.y * q.y; const sqz = q.z * q.z;
                heading = Math.atan2(2 * q.y * q.w - 2 * q.x * q.z, 1 - 2 * sqy - 2 * sqz);
                attitude = Math.asin(2 * test);
                bank = Math.atan2(2 * q.x * q.w - 2 * q.y * q.z, 1 - 2 * sqx - 2 * sqz);
            }
            return new THREE.Euler(bank, heading, attitude);
        };

        // Instantiate
        window.app = new App();

    </script>
</body>

</html>